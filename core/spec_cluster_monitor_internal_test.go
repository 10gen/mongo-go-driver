// Code generated by "spec_cluster_monitor_internal_test_generator.go"; DO NOT EDIT

package core

import "testing"
import "gopkg.in/mgo.v2/bson"
import "github.com/10gen/mongo-go-driver/core/connstring"
import "github.com/10gen/mongo-go-driver/core/desc"

func TestClusterMonitorFSM_Discover_arbiters(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Arbiters = []string{"b:27017"}
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Discover_passives(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.Passives = []string{"b:27017"}
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.Passives = []string{"b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Replica_set_discovery_from_primary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Replica_set_discovery_from_secondary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Replica_set_discovery(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017", "d:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017", "d:27017", "e:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("d:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("e:27017"))
	if !ok {
		t.Fatalf("server e:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 4 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("c:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 4 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("e:27017"))
	if !ok {
		t.Fatalf("server e:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_New_primary_with_equal_electionId(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Ghost_discovered(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsReplicaSet = true
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSGhost {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSGhost, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Host_list_differs_from_seeds(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Member_removed_by_reconfig(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Member_brought_up_as_standalone(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.UnknownClusterType {
		t.Fatalf("expected fsm.ClusterType to be desc.UnknownClusterType, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_New_primary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_New_primary_with_greater_setVersion_and_electionId(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_New_primary_with_greater_setVersion(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_New_primary_with_wrong_setName(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Non_replicaSet_member_responds(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Replica_set_case_normalization(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://A/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Arbiters = []string{"C:27017"}
	imr.Hosts = []string{"A:27017"}
	imr.IsMaster = true
	imr.Passives = []string{"B:27017"}
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primaries_with_and_without_electionIds(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 4 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("c:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 4 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primary_becomes_standalone(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestClusterMonitorFSM_Primary_changes_setName(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestClusterMonitorFSM_Disconnected_from_primary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Disconnected_from_primary__reject_primary_with_stale_electionId(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 4 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000003")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 4 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 5 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 5 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Disconnected_from_primary__reject_primary_with_stale_setVersion(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 4 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 4 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 5 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 5 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Secondary_with_mismatched__me__tells_us_who_the_primary_is(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.Me = "c:27017"
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.Me = "b:27017"
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primary_mismatched_me(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://localhost:27017/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.Me = "a:27017"
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("localhost:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primary_reports_a_new_member(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 4 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("c:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 4 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primary_to_no_primary_with_mismatched_me(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.Me = "a:27017"
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"c:27017", "d:27017"}
	imr.IsMaster = true
	imr.Me = "c:27017"
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primary_wrong_setName(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestClusterMonitorFSM_Response_from_removed_server(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_RSOther_discovered(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hidden = true
	imr.Hosts = []string{"c:27017", "d:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"c:27017", "d:27017"}
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSMember {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSMember, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSMember {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSMember, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Secondary_s_host_list_is_not_authoritative(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Secondary_mismatched_me(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://localhost:27017/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Me = "a:27017"
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("localhost:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Secondary_wrong_setName(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestClusterMonitorFSM_Secondary_wrong_setName_with_primary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_setVersion_is_ignored_if_there_is_no_electionId(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Primary_becomes_a_secondary_with_wrong_setName(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestClusterMonitorFSM_Unexpected_mongos(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestClusterMonitorFSM_Record_max_setVersion__even_from_primary_without_electionId(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetWithPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Wrong_setName(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "rs" {
		t.Fatalf("expected fsm.setName to be \"rs\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.ClusterType to be desc.ReplicaSetNoPrimary, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Mongos_disconnect(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Sharded {
		t.Fatalf("expected fsm.ClusterType to be desc.Sharded, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 2 - response 1
	imr = &isMasterResult{}
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 2 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Sharded {
		t.Fatalf("expected fsm.ClusterType to be desc.Sharded, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}

	// phase 3 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 3 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Sharded {
		t.Fatalf("expected fsm.ClusterType to be desc.Sharded, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Multiple_mongoses(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Sharded {
		t.Fatalf("expected fsm.ClusterType to be desc.Sharded, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Non_Mongos_server_in_sharded_cluster(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("b:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Sharded {
		t.Fatalf("expected fsm.ClusterType to be desc.Sharded, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Normalize_URI_case(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://A,B")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.UnknownClusterType {
		t.Fatalf("expected fsm.ClusterType to be desc.UnknownClusterType, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	var serverDesc *desc.Server
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Direct_connection_to_RSPrimary_via_external_IP(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Connect_to_mongos(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Mongos {
		t.Fatalf("expected serverDesc.ServerType to be desc.Mongos, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Connect_to_RSArbiter(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.ArbiterOnly = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSArbiter {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSArbiter, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Connect_to_RSPrimary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSPrimary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSPrimary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Connect_to_RSSecondary(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.RSSecondary {
		t.Fatalf("expected serverDesc.ServerType to be desc.RSSecondary, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Direct_connection_to_slave(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Standalone {
		t.Fatalf("expected serverDesc.ServerType to be desc.Standalone, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Connect_to_standalone(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.Standalone {
		t.Fatalf("expected serverDesc.ServerType to be desc.Standalone, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Handle_a_not_ok_ismaster_response(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 - response 2
	imr = &isMasterResult{}
	imr.IsMaster = true
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Standalone_removed_from_multi_server_topology(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.UnknownClusterType {
		t.Fatalf("expected fsm.ClusterType to be desc.UnknownClusterType, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}

func TestClusterMonitorFSM_Unavailable_seed(t *testing.T) {
	t.Parallel()

	var fsm clusterMonitorFSM

	cs, _ := connstring.Parse("mongodb://a")
	fsm.setName = cs.ReplicaSet
	if fsm.setName != "" {
		fsm.ClusterType = desc.ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.setName == "" {
		fsm.ClusterType = desc.Single
	}
	for _, host := range cs.Hosts {
		fsm.addServer(desc.Endpoint(host).Canonicalize())
	}

	var serverDesc *desc.Server
	bir := &buildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *isMasterResult

	// phase 1 - response 1
	imr = &isMasterResult{}
	serverDesc = buildServerDesc(desc.Endpoint("a:27017"), imr, bir)
	fsm.apply(serverDesc)

	// phase 1 outcome
	if fsm.setName != "" {
		t.Fatalf("expected fsm.setName to be \"\", but got \"%v\"", fsm.setName)
	}
	if fsm.ClusterType != desc.Single {
		t.Fatalf("expected fsm.ClusterType to be desc.Single, but got \"%v\"", fsm.ClusterType)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	serverDesc, ok = fsm.Server(desc.Endpoint("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if serverDesc.ServerType != desc.UnknownServerType {
		t.Fatalf("expected serverDesc.ServerType to be desc.UnknownServerType, but got \"%v\"", serverDesc.ServerType)
	}
}
